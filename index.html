<script>
  const today = new Date();
  let currentDate = new Date();

  const savedData = JSON.parse(localStorage.getItem("simulakraCalendar")) || {};
  const calendar = document.getElementById("calendar");
  const modal = document.getElementById("modal");
  const contentType = document.getElementById("contentType");
  const contentText = document.getElementById("contentText");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const monthLabel = document.getElementById("monthLabel");
  let activeDay = null;

  function renderCalendar() {
    calendar.innerHTML = "";
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const todayStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
    const firstDayOfMonth = new Date(year, month, 1);
    const startDay = firstDayOfMonth.getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const totalSlots = 35; // 5 weeks * 7 days

    monthLabel.textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

    // Fill in the days before the 1st of the month
    const days = [];
    for (let i = 0; i < startDay; i++) {
      days.push(null);
    }

    // Fill in the days of the current month
    for (let i = 1; i <= daysInMonth; i++) {
      days.push(new Date(year, month, i));
    }

    // Fill in the rest to complete 5 full weeks
    while (days.length < totalSlots) {
      const nextDate = new Date(year, month, daysInMonth + (days.length - startDay - daysInMonth) + 1);
      days.push(nextDate);
    }

    days.forEach(date => {
      const dayEl = document.createElement("div");
      dayEl.classList.add("day");

      if (!date) {
        calendar.appendChild(dayEl);
        return;
      }

      const dateKey = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;
      if (dateKey === todayStr) dayEl.classList.add("today");
      if (date < new Date(today.getFullYear(), today.getMonth(), today.getDate())) dayEl.classList.add("past");
      if (date.getDay() === 2 || date.getDay() === 3) dayEl.classList.add("grayed");
      if (date.getMonth() !== month) dayEl.style.opacity = 0.4;

      dayEl.dataset.date = dateKey;
      dayEl.innerHTML = `<span>${date.getDate()}</span>`;

      if (savedData[dateKey]) {
        savedData[dateKey].forEach((event, index) => {
          addEventElement(dayEl, dateKey, event, index);
        });
      }

      dayEl.addEventListener("click", () => {
        activeDay = dayEl;
        modal.style.display = "flex";
        contentText.value = "";
        contentType.value = "youtube";
      });

      calendar.appendChild(dayEl);
    });
  }

  function addEventElement(container, dateKey, event, index) {
    const label = document.createElement("div");
    label.classList.add("event", event.type);
    label.innerHTML = `<span>ðŸ“Œ</span> ${event.text} <button class='delete-btn' onclick='deleteEvent("${dateKey}", ${index})'>âœ–</button>`;
    container.appendChild(label);
  }

  function deleteEvent(dateKey, index) {
    savedData[dateKey].splice(index, 1);
    if (savedData[dateKey].length === 0) delete savedData[dateKey];
    localStorage.setItem("simulakraCalendar", JSON.stringify(savedData));
    renderCalendar();
  }

  function changeMonth(offset) {
    currentDate.setMonth(currentDate.getMonth() + offset);
    renderCalendar();
  }

  closeModalBtn.addEventListener("click", () => {
    modal.style.display = "none";
  });

  window.addEventListener("click", (e) => {
    if (e.target === modal) modal.style.display = "none";
  });

  function addEventToDay() {
    const type = contentType.value;
    const text = contentText.value.trim();
    if (!text || !type || !activeDay) return;
    const dateKey = activeDay.dataset.date;
    const newEvent = { type, text };
    if (!savedData[dateKey]) savedData[dateKey] = [];
    savedData[dateKey].push(newEvent);
    localStorage.setItem("simulakraCalendar", JSON.stringify(savedData));
    addEventElement(activeDay, dateKey, newEvent, savedData[dateKey].length - 1);
    modal.style.display = "none";
    activeDay = null;
  }

  renderCalendar();
</script>
